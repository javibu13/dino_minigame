<html>
    <head>
        <style>
            #canvas_game {
              background-color: gainsboro;
              display: block;
              /* width: 100%; */
              height: 95vh;
              aspect-ratio: 16 / 9;
              margin-left: auto;
              margin-right: auto;
              image-rendering: pixelated;
              image-rendering: -moz-crisp-edges;
              image-rendering: crisp-edges;
              image-rendering: -o-pixelated;
            }
            
            img.flipx {
              -moz-transform: scale(-1, 1);
              -webkit-transform: scale(-1, 1);
              -o-transform: scale(-1, 1);
              transform: scale(-1, 1);
              filter: FlipH;
            }
        </style>
    </head>
    <body id="body">
        <img src="./graphics/pixel_dino_idle.png" id="img_dino_idle" hidden>
        <img src="./graphics/pixel_dino_run1.png" id="img_dino_run1" hidden>
        <img src="./graphics/pixel_dino_run2.png" id="img_dino_run2" hidden>
        <img src="./graphics/pixel_dino_idle_flip.png" id="img_dino_idle_flip" hidden>
        <img src="./graphics/pixel_dino_run1_flip.png" id="img_dino_run1_flip" hidden>
        <img src="./graphics/pixel_dino_run2_flip.png" id="img_dino_run2_flip" hidden>
        <img src="./graphics/pixel_dino_shadow.png" id="img_dino_shadow" hidden>
        <canvas id ="canvas_game"></canvas>
        <p id="debug_text"></p>
        <p id="h_pos"></p>
        <p id="v_pos"></p>
        
        <script>
        
            class EnemyBar {
                
                static align_options = ["h", "v"];
                
                constructor(canvas, context, align, thickness = 4, speed = 2) {
                    this.canvas = canvas;
                    this.context = context;
                    this.way = 1;
                    if (align == "h" || align == "v") {
                        this.align = align;
                    } else {
                        this.align_options = EnemyBar.align_options;
                        let random_n = Math.floor(Math.random() * this.align_options.length);
                        this.align = this.align_options[random_n];
                        //console.log(this.align);
                    }
                    if (this.align == "v") {
                        this.speed = speed / 2;
                    } else {
                        this.speed = speed;
                    }
                    this.thickness = thickness;
                    this.position = {
                        x : 0,
                        y : 0,
                    };
                    
                }

                draw() {
                    this.context.fillStyle = "#646464";
                    if (this.align == "h") {
                        this.context.fillRect(this.position.x, 0, this.thickness, this.canvas.height);
                    } else if (this.align == "v") {
                        this.context.fillRect(0, this.position.y, this.canvas.width, this.thickness);
                    }
                }

                move() {
                    if (this.align == "h") {
                        if (this.way == 1 && (this.position.x + this.speed) > this.canvas.width) {
                            this.way = -1;
                        } else if (this.way == -1 && (this.position.x - this.speed) < 0) {
                            this.way = 1;
                        }
                        this.position.x += this.speed * this.way;
                    } else if (this.align == "v") {
                        if (this.way == 1 && (this.position.y + this.speed) > this.canvas.height) {
                            this.way = -1;
                        } else if (this.way == -1 && (this.position.y - this.speed) < 0) {
                            this.way = 1;
                        }
                        this.position.y += this.speed * this.way;
                    }
                }
                
                checkCollision(position_x, position_y, width, height) {
                    let isColliding = false;
                    if (this.align == "h") {
                        if (position_x < this.position.x && (position_x + width) > this.position.x) {
                            isColliding = true;
                        } else if (position_x >= this.position.x && position_x < (this.position.x + this.thickness)) {
                            isColliding = true;
                        }
                    } else if (this.align == "v") {
                        if (position_y < this.position.y && (position_y + height) > this.position.y) {
                            isColliding = true;
                        } else if (position_y >= this.position.y && position_y < (this.position.y + this.thickness)) {
                            isColliding = true;
                        }
                    }
                    return isColliding;
                }
                
            }
        
            const canvas = document.getElementById("canvas_game");
            const img_dino_idle_no_flip = document.getElementById("img_dino_idle");
            const img_dino_run1_no_flip = document.getElementById("img_dino_run1");
            const img_dino_run2_no_flip = document.getElementById("img_dino_run2");
            const img_dino_idle_flip = document.getElementById("img_dino_idle_flip");
            const img_dino_run1_flip = document.getElementById("img_dino_run1_flip");
            const img_dino_run2_flip = document.getElementById("img_dino_run2_flip");
            const img_dino_shadow = document.getElementById("img_dino_shadow");
            const dino_size_px = 20;
            let img_dino_idle = img_dino_idle_no_flip;
            let img_dino_run1 = img_dino_run1_no_flip;
            let img_dino_run2 = img_dino_run2_no_flip;
            // img_dino_idle.src = "./pixel_dino_idle.png";
            let ctx = canvas.getContext("2d");
            ctx.imageSmoothingEnabled = false;
            let dino_x = 0;
            let dino_y = 0;
            let dino_speed = 1;
            let dino_jump_height = 0;
            // let dino_jump_max_height = 15;
            const gravity = 0.1;
            const dino_jump_force = 2;
            let dino_jump_actual_force = 0;
            let dino_run_img = img_dino_run1;
            let run_interval = null;

            let up_pressed = false;
            let down_pressed = false;
            let left_pressed = false;
            let right_pressed = false;
            let jump_pressed = false;
            let is_jumping = false;

            let enemy_bars = [];
            enemy_bars.push(new EnemyBar(canvas, ctx, ""));
            //console.log(test_bar.align);
            
            let score = 0;
            let max_score = 0;
            
            document.addEventListener("keydown", keyDownHandler, false);
            document.addEventListener("keyup", keyUpHandler, false);

            function keyDownHandler(e){
                if (e.key == "w" || e.key == "ArrowUp") {
                    up_pressed = true;
                }
                if (e.key == "s" || e.key == "ArrowDown") {
                    down_pressed = true;
                }
                if (e.key == "a" || e.key == "ArrowLeft") {
                    left_pressed = true;
                }
                if (e.key == "d" || e.key == "ArrowRight") {
                    right_pressed = true;
                }
                if (e.key == " ") {
                    jump_pressed = true;
                    e.preventDefault();
                }
            }
            
            function keyUpHandler(e){
                if (e.key == "w" || e.key == "ArrowUp") {
                    up_pressed = false;
                }
                if (e.key == "s" || e.key == "ArrowDown") {
                    down_pressed = false;
                }
                if (e.key == "a" || e.key == "ArrowLeft") {
                    left_pressed = false;
                }
                if (e.key == "d" || e.key == "ArrowRight") {
                    right_pressed = false;
                }
                if (e.key == "space") {
                    jump_pressed = false;
                }
            }
            
            function drawScore () {
                ctx.font = "128px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillStyle = "#d6d6d6";
                ctx.fillText(score, canvas.width/2, canvas.height/2);
            }

            function drawDino (img_to_draw) {
                if (img_to_draw.id.endsWith("flip")) {
                    ctx.drawImage(img_dino_shadow, dino_x+4, dino_y+13, 14, 14);
                } else {
                    ctx.drawImage(img_dino_shadow, dino_x+2, dino_y+13, 14, 14);
                }
                document.getElementById("debug_text").innerText = img_to_draw.id;
                ctx.drawImage(img_to_draw, dino_x, dino_y-dino_jump_height, dino_size_px, dino_size_px);
                document.getElementById("h_pos").innerText = dino_x;
                document.getElementById("v_pos").innerText = dino_y;
            }
            
            function drawEnemyBars() {
                enemy_bars.forEach(enemy_bar => {
                    enemy_bar.draw();
                });
            }
            
            function moveEnemyBars() {
                enemy_bars.forEach(enemy_bar => {
                    enemy_bar.move();
                });
            }
            
            function checkCollisionEnemyBars(position_x, position_y, width, height) {
                let result = false;
                enemy_bars.forEach(enemy_bar => {
                    result = enemy_bar.checkCollision(position_x, position_y, width, height);
                    if (result) {
                        return false;
                    }
                });
                if (result) {
                    console.log("GAME OVER");
                    
                    
                    setMaxScore(score);
                    score = 0;
                    
                    
                    ctx.fillStyle = "red";
                    
                    
                    ctx.fillRect(0, 0, 5, 5);
                }
            }

            function draw () {
                // Clear canvas elements to draw next frame
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw score
                drawScore();
                
                // If dino is not jumping
                if (!is_jumping) {
                    // Check collisions with enemy bars
                    checkCollisionEnemyBars(dino_x+4, dino_y+13, 14, 14);
                    
                }
                
                // Store dino's actual position to check if it changes during this draw step (frame)
                let prev_dino_x = dino_x;
                let prev_dino_y = dino_y;
                
                // Try to move the dino if it is possible
                let move_factor = 1;
                if ((left_pressed || right_pressed) && (up_pressed || down_pressed)) {
                    move_factor = 0.75;
                }
                if (!(left_pressed && right_pressed)) {
                    if (left_pressed && (dino_x - dino_speed >= 0)) {
                        dino_flipx(true);
                        dino_x -= dino_speed * move_factor;
                        //dino_x = Math.round(dino_x);
                    }
                    else if (right_pressed && (dino_x + dino_speed <= canvas.width - dino_size_px)) {
                        dino_flipx(false);
                        dino_x += dino_speed * move_factor;
                        //dino_x = Math.round(dino_x);
                    }
                }
                if (!(up_pressed && down_pressed)) {
                    if (up_pressed && (dino_y - dino_speed >= 0)) {
                        dino_y -= dino_speed * move_factor;
                        //dino_y = Math.round(dino_y);
                    }
                    else if (down_pressed && (dino_y + dino_speed <= canvas.height - dino_size_px)) {
                        dino_y += dino_speed * move_factor;
                        //dino_y = Math.round(dino_y);
                    }
                }
                
                // Check if dino moved to update sprite
                let is_moving = false;
                let img_to_draw = img_dino_idle
                if (prev_dino_x != dino_x || prev_dino_y != dino_y) {
                  is_moving = true;
                  if (!run_interval) {
                    run_interval = setInterval(run_anim, 90);
                  }
                  img_to_draw = dino_run_img;
                } else if (run_interval) {
                  clearInterval(run_interval);
                  run_interval = null;
                } 
                
                // Calculate jump
                if (jump_pressed || is_jumping) {
                  if (!is_jumping) {
                    is_jumping = true;
                    jump_pressed = false;
                    dino_jump_height = 0;
                    dino_jump_actual_force = dino_jump_force;
                  }
                  calculate_jump();
                }
                
                moveEnemyBars();

                drawDino(img_to_draw);
                
                drawEnemyBars();
            }
            
            function calculate_jump() {
              dino_jump_height += dino_jump_actual_force;
              dino_jump_actual_force -= gravity;
              if (dino_jump_height < 0) {
                is_jumping = false;
                dino_jump_height = 0;
              }
            }
            
            function run_anim() {
              if (dino_run_img != img_dino_run1) {
                dino_run_img = img_dino_run1
              } else {
                dino_run_img = img_dino_run2
              }
            }

            function dino_flipx(flip) {
                if (flip) {
                    img_dino_idle = img_dino_idle_flip;
                    img_dino_run1 = img_dino_run1_flip;
                    img_dino_run2 = img_dino_run2_flip;
                } else {
                    img_dino_idle = img_dino_idle_no_flip;
                    img_dino_run1 = img_dino_run1_no_flip;
                    img_dino_run2 = img_dino_run2_no_flip;
                }
                
                
            }
            
            function setMaxScore(new_score) {
                // TODO: Store the new score in memory if is higher than the previously.
                max_score = new_score;
            }

            document.getElementById("body").onload = function() {
                setInterval(draw, 10);
                
            }

            

        </script>
    </body>
</html>